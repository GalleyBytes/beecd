{{- if .Values.hiveServer.enabled }}
{{- if not .Values.hiveServer.database.hive.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-hive-db
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  DATABASE_HOST: {{ include "beecd.hive.database.host" . | quote }}
  DATABASE_HOST_RO: {{ default (include "beecd.hive.database.host" .) .Values.hiveServer.database.hive.hostRo | quote }}
  DATABASE_PORT: {{ .Values.hiveServer.database.hive.port | quote }}
  DATABASE_NAME: {{ .Values.hiveServer.database.hive.name | quote }}
  DATABASE_USER: {{ .Values.hiveServer.database.hive.user | quote }}
  DATABASE_PASSWORD: {{ required "hiveServer.database.hive.password is required" .Values.hiveServer.database.hive.password | quote }}
  {{- if and .Values.hiveServer.database.admin .Values.hiveServer.database.admin.user }}
  # Admin credentials for running migrations (table owner, bypasses RLS)
  DATABASE_ADMIN_USER: {{ .Values.hiveServer.database.admin.user | quote }}
  DATABASE_ADMIN_PASSWORD: {{ .Values.hiveServer.database.admin.password | quote }}
  {{- end }}
{{- end }}
---
{{- if and (or .Values.hiveServer.github.user .Values.hiveServer.github.token) (not .Values.hiveServer.github.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-github
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.hiveServer.github.user }}
  GHUSER: {{ .Values.hiveServer.github.user | quote }}
  {{- end }}
  {{- if .Values.hiveServer.github.token }}
  GHPASS: {{ .Values.hiveServer.github.token | quote }}
  {{- end }}
  {{- if .Values.hiveServer.github.apiUrl }}
  GITHUB_API_URL: {{ .Values.hiveServer.github.apiUrl | quote }}
  {{- end }}
{{- end }}
---
{{- if and (or .Values.hiveServer.sops.fingerprint .Values.hiveServer.sops.gpgKey) (not .Values.hiveServer.sops.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-sops
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.hiveServer.sops.fingerprint }}
  FINGER_PRINT: {{ .Values.hiveServer.sops.fingerprint | quote }}
  {{- end }}
  {{- if .Values.hiveServer.sops.gpgKey }}
  GPG_KEY: {{ .Values.hiveServer.sops.gpgKey | quote }}
  {{- end }}
{{- end }}
---
{{- if and .Values.hiveServer.enabled .Values.hiveServer.jwt.secretKey (not .Values.hiveServer.jwt.existingSecret) }}
{{- if lt (len .Values.hiveServer.jwt.secretKey) 43 }}
{{- fail "JWT_SECRET_KEY must be at least 43 characters (base64-encoded 32 bytes). Generate with: openssl rand -base64 48" }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-jwt
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
    app.kubernetes.io/component: hive-server
type: Opaque
stringData:
  JWT_SECRET_KEY: {{ .Values.hiveServer.jwt.secretKey | quote }}
  {{- if .Values.hiveServer.jwt.accessTokenTtl }}
  ACCESS_TOKEN_TTL: {{ .Values.hiveServer.jwt.accessTokenTtl | quote }}
  {{- end }}
  {{- if .Values.hiveServer.jwt.refreshTokenTtl }}
  REFRESH_TOKEN_TTL: {{ .Values.hiveServer.jwt.refreshTokenTtl | quote }}
  {{- end }}
{{- end }}
---
{{- if and .Values.hiveServer.storage.s3.enabled (not .Values.hiveServer.storage.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-storage
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  AWS_S3_STORAGE_BUCKET: {{ required "hiveServer.storage.s3.bucket is required" .Values.hiveServer.storage.s3.bucket | quote }}
  AWS_REGION: {{ .Values.hiveServer.storage.s3.region | quote }}
  AWS_ACCESS_KEY_ID: {{ required "hiveServer.storage.s3.accessKeyId is required" .Values.hiveServer.storage.s3.accessKeyId | quote }}
  AWS_SECRET_ACCESS_KEY: {{ required "hiveServer.storage.s3.secretAccessKey is required" .Values.hiveServer.storage.s3.secretAccessKey | quote }}
{{- else if and .Values.hiveServer.storage.minio.enabled (not .Values.hiveServer.storage.existingSecret) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-storage
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  AWS_ENDPOINT_URL: {{ include "beecd.minio.endpoint" . | quote }}
  AWS_S3_STORAGE_BUCKET: {{ .Values.hiveServer.storage.minio.bucket | quote }}
  AWS_REGION: {{ .Values.hiveServer.storage.minio.region | quote }}
  AWS_ACCESS_KEY_ID: {{ .Values.hiveServer.storage.minio.accessKeyId | quote }}
  AWS_SECRET_ACCESS_KEY: {{ .Values.hiveServer.storage.minio.secretAccessKey | quote }}
{{- end }}
{{- if and .Values.hiveHq.enabled (not .Values.hiveHq.jwt.existingSecret) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-hive-hq
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  JWT_SECRET: {{ required "hiveHq.jwt.secret is required" .Values.hiveHq.jwt.secret | quote }}
{{- end }}
{{- if and .Values.hiveHq.enabled (not .Values.hiveHq.database.existingSecret) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-hive-hq-db
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
type: Opaque
stringData:
  DATABASE_HOST: {{ include "beecd.hive.database.host" . | quote }}
  DATABASE_HOST_RO: {{ default (include "beecd.hive.database.host" .) .Values.hiveHq.database.hostRo | quote }}
  DATABASE_PORT: {{ .Values.hiveHq.database.port | quote }}
  DATABASE_NAME: {{ .Values.hiveHq.database.name | quote }}
  DATABASE_USER: {{ .Values.hiveHq.database.user | quote }}
  DATABASE_PASSWORD: {{ required "hiveHq.database.password is required" .Values.hiveHq.database.password | quote }}
{{- end }}
---
{{- if and .Values.hiveServer.crypto.encryptionKey (not .Values.hiveServer.crypto.existingSecret) }}
{{- if lt (len .Values.hiveServer.crypto.encryptionKey) 43 }}
{{- fail "ENCRYPTION_KEY must be at least 43 characters (base64-encoded 32 bytes). Generate with: openssl rand -base64 48" }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "beecd.fullname" . }}-crypto
  labels:
    {{- include "beecd.labels" . | nindent 4 }}
    app.kubernetes.io/component: crypto
type: Opaque
stringData:
  ENCRYPTION_KEY: {{ .Values.hiveServer.crypto.encryptionKey | quote }}
  {{- if .Values.hiveServer.crypto.bootstrapKey }}
  HIVE_CRYPTO_ROOT_KEY: {{ .Values.hiveServer.crypto.bootstrapKey | quote }}
  {{- end }}
{{- end }}
{{- end }}
